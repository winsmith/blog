---
layout: post
title:  "Test Post"
subtitle: "Please Don't Ignore"
date:   2020-01-01 00:00:00 +0000
categories: test
---

<p class="lead">If you develop an iOS app, you know this: <strong>Creating screenshots is a lot of work.</strong> You need updated screenshots for all your device types in all your languages, and manually creating all those takes a long time. </p>

Lots of people are using [fastlane](https://fastlane.tools) to create their screenshots, but for a variety of reasons, I decided against it. I had tried it out before, but it doesn't really fit into my development workflow, and it feels like too much for just taking screenshots.

Fastlane uses XCUITest to take screenshots anyway, so I decided to try out if I could **recreate the functionality of `fastlane snapshot`** without using Ruby, without installing any gems, and without having to buy into the fastlane ecosystem.

After some fiddling, here are my results.

## Overview over the Process

Here are the steps we need to take:

1. Run Xcode UI Tests that take screenshots
1. Run the Tests from the command line
1. Extract those screenshots from the test logs
1. Run those steps for each combination of device and language.

Below are my solutions to all 4 steps, plus some addenda that make things easier. If you're stuck, read through to the bottom to see if a solution to your problen is already there. 

## First Step: Run Xcode UI Tests that Take Screenshots

### Setting Things up

Even if you already have a UI Testing Target, you should probably create a new one for your screenshots. If not, welcome to the world of UI testing! 

1. In Xcode, go to `File > New > Target...` and select ‚ÄúUI testing bundle‚Äù.
1. Call the Bundle something like "YourAppScreenshots" and click "Finish".
1. Edit your app‚Äôs scheme to run your UI tests when testing: Go to `Product > Scheme > Edit Scheme...` click on ‚ÄúTest‚Äù in the sidebar, and enable your new bundle. (Newer Xcode versions might already have it enabled, so no need to do anything in this case)

### Create a Test

Add a new property to your test class to keep track of the `XCUIApplication`:

```swift
var app: XCUIApplication!
```

then initialize the `app` property in your setup method:

```swift
override func setUpWithError() throws {
    continueAfterFailure = false
    app = XCUIApplication()

    // We send a command line argument to our app,
    // to enable it to reset its state
    app.launchArguments.append("--libiScreenshots")
}
```

Now you can create your first test. I put the whole screenshot flow into one test, but might split individual flows off into their own test functions later:

```swift
func testMakeScreenshots() {
    app.launch()
    
    // Overview
    takeScreenshot(named: "Overview")

    // Insights
    app.tabBars.buttons["Deep Insights"].tap()
    takeScreenshot(named: "Insights")
}
```

This test uses a function called `takeScreenshot(named:)`, which extracts the correct way of taking screenshots in our situation. 


### Take Screenshots

Since we want to identify our screenshots, we name them. And since we want to keep them until after the end of the test is run, we'll also have to mark them as "keep always".

```swift
func takeScreenshot(named name: String) {
    // Take the screenshot
    let fullScreenshot = XCUIScreen.main.screenshot()
    
    // Create a new attachment to save our screenshot
    // and give it a name consisting of the "named"
    // parameter and the device name, so we can find
    // it later.
    let screenshotAttachment = XCTAttachment(
        uniformTypeIdentifier: "public.png", 
        name: "Screenshot-\(UIDevice.current.name)-\(name).png",
        payload: fullScreenshot.pngRepresentation, 
        userInfo: nil)
        
    // Usually Xcode will delete attachments after 
    // the test has run; we don't want that!
    screenshotAttachment.lifetime = .keepAlways
    
    // Add the attachment to the test log, 
    // so we can retrieve it later
    add(screenshotAttachment)
}
```

After this step, you can already see the screen shots in the test logs. Make sure that is the case.

// TODO: Test log image

## Second Step: Run Tests from the Command Line

```bash
$ xcodebuild -testLanguage de -scheme Libi -project ./Libi.xcodeproj -derivedDataPath '/tmp/LibiDerivedData/' -destination "platform=iOS Simulator,name=iPhone 11 Pro Max" build test
```

## Third Step: Extract Screenshots from the Test Logs

Get xcparse: https://github.com/ChargePoint/xcparse

```bash
$ xcparse screenshots /tmp/LibiDerivedData/Logs/Test/Run-Libi-2020.04.13_13-06-03-+0200.xcresult "~/Desktop/LibiScreenshots/"
```

## Fourth Step: Run for each Combination of Device and Language.

```bash
#!/bin/bash

simulators=( "iPhone 8" "iPhone 11 Pro" "iPhone 11 Pro Max" "iPad Pro (12.9-inch) (3rd generation)", "iPad Pro (9.7-inch)" )
languages=( "en" "de" "fr" )
targetFolder="/Users/breakthesystem/Desktop/LibiScreenshots"



for simulator in "${simulators[@]}"
do
    for language in "${languages[@]}"
    do
        rm -rf /tmp/LibiDerivedData/Logs/Test
        echo "üì≤  Building and Running for $simulator in $language"
        xcodebuild -testLanguage $language -scheme Libi -project ./Libi.xcodeproj -derivedDataPath '/tmp/LibiDerivedData/' -destination "platform=iOS Simulator,name=$simulator" build test
        echo "üñº  Collecting Results..."
        mkdir -p "$targetFolder/$simulator/$language"
        find /tmp/LibiDerivedData/Logs/Test -maxdepth 1 -type d -exec xcparse screenshots {} "$targetFolder/$simulator/$language" \;
    done

    echo "‚úÖ  Done"
done
```

----

## Addendum One: Launch Arguments and Resetting States

## Addendum Two: Accessibility Identifiers

## Addendum Three: Sleeping, Swiping, and More
```swift
sleep(2)
takeScreenshot(named: "Insights_1")
app.collectionViews["DeppInsightsViewController"].swipeUp()
takeScreenshot(named: "Insights_2")
```

----

## Sources

- [Apple WWDC: Testing in Xcode](https://developer.apple.com/videos/play/wwdc2019/413/)
- [Paul Hudson: Xcode UI Testing Cheat Sheet](https://www.hackingwithswift.com/articles/148/xcode-ui-testing-cheat-sheet)
- [Derik Ramirez: Understanding XCUITest screenshots and how to access them](https://rderik.com/blog/understanding-xcuitest-screenshots-and-how-to-access-them/)
- [Swift by Sundell: Getting started with Xcode UI testing in Swift](https://www.swiftbysundell.com/articles/getting-started-with-xcode-ui-testing-in-swift/)
- [ChargePoint: xcparse](https://github.com/ChargePoint/xcparse)
